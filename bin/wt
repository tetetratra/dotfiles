#! /usr/bin/env ruby

branch = ARGV[0]
parent_dir = `pwd`.chomp

puts `git fetch`

puts '現在のworktree一覧'
worktrees_str = `git worktree list`
puts worktrees_str
puts

worktrees = worktrees_str.lines

if worktrees.any? { |wt| wt.include?('prunable') }
  puts "prunableなworktreeがあります。削除します"
  puts `git worktree prune`
end

if branch.nil?
  puts "branch名を指定してください"
  exit 1
end

# ブランチが存在するか確認し、なければ作成
branch_exists = system("git show-ref --verify --quiet refs/heads/#{branch}")
unless branch_exists
  puts "#{branch} ブランチが存在しません。新規作成します。"
  default_branch = `git default-branch`.chomp
  puts "#{default_branch} から #{branch} を作成します。"
  system("git branch #{branch} #{default_branch}")
end

dir = branch.gsub('/','-')

puts `git worktree add wt/#{dir} #{branch}`

copy_targets = ENV['WT_COPY_TARGETS'].split(',')
copy_targets.each do |ct|
  `cp -r #{parent_dir}/#{ct} #{parent_dir}/wt/#{dir}/#{ct}`
end

link_targets = ENV['WT_LINK_TARGETS'].split(',')
link_targets.each do |lt|
  `ln -sf #{parent_dir}/#{lt} #{parent_dir}/wt/#{dir}/#{lt}`
end

puts "\nwt/#{dir} に移動してください"

