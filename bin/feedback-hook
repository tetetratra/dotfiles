#!/usr/bin/env ruby
# feedback-hook
#
# Claude CodeのHookスクリプト。
# セッション終了時（SessionEnd/PreCompactイベント）に自動実行され、
# AIが自身の作業を振り返ってリポジトリ固有のスキルを自動更新する。
#
# 動作概要：
# 1. 標準入力からHook JSON（session_id, cwd等）を受け取る
# 2. 環境変数CLAUDE_FEEDBACK_HOOK_RUNNINGをチェック（無限ループ防止）
# 3. 別プロセスでClaude Codeを起動し、self-reflectionスキルを実行

require 'json'
require 'fileutils'

# ログファイルのパス
log_file = File.join(Dir.pwd, 'tmp', 'feedback-hook-log.log')
FileUtils.mkdir_p(File.dirname(log_file))

def log_message(log_file, message)
  File.open(log_file, 'a') do |f|
    f.puts "[#{Time.now}] #{message}"
  end
end

log_message(log_file, "=== feedback-hook started ===")

# 標準入力からJSON読み込み
input = STDIN.read
log_message(log_file, "Input received: #{input}")

hook_data = JSON.parse(input)
log_message(log_file, "JSON parsed successfully")

# 必要な情報を取得
session_id = hook_data['session_id']
cwd = hook_data['cwd']
log_message(log_file, "session_id: #{session_id}")
log_message(log_file, "cwd: #{cwd}")

# 無限ループ防止：環境変数がtrueの場合は何もせず終了
if ENV['CLAUDE_FEEDBACK_HOOK_RUNNING'] == 'true'
  log_message(log_file, "CLAUDE_FEEDBACK_HOOK_RUNNING is true, exiting")
  exit 0
end
log_message(log_file, "CLAUDE_FEEDBACK_HOOK_RUNNING is not set, proceeding")

# 初期プロンプト
prompt = "self-skill-reflectionスキルを使って、先ほどの作業セッションの振り返りを行ってください。"
log_message(log_file, "prompt: #{prompt}")

# Claude Codeを起動（環境変数設定、cwd移動、セッション継続）
# 非同期でバックグラウンド実行し、すぐに終了
command = "cd #{cwd} && echo '#{prompt}' | claude --resume #{session_id}"
log_message(log_file, "Executing command: #{command}")

pid = Process.spawn({
  'CLAUDE_FEEDBACK_HOOK_RUNNING' => 'true'
}, command,
  in: :close,      # 標準入力を閉じる
  out: :close,     # 標準出力を閉じる
  err: :close      # 標準エラー出力を閉じる
)
Process.detach(pid)
log_message(log_file, "Process spawned with PID: #{pid}, I/O closed, detached and returning immediately")
