#!/usr/bin/env ruby

# 使い方
# worktree <branch名>

branch = ARGV[0]

if branch.nil? || branch.empty?
  puts "Usage: worktree <branch名>"
  exit 1
end

# 現在のディレクトリを保存
parent_dir = `pwd`.chomp

# デフォルトの除外パターン
DEFAULT_EXCLUDES = ['.DS_Store', 'tags', '*.log', '.ruby-lsp', '.worktree']
excludes = DEFAULT_EXCLUDES

# デフォルトブランチを取得
default_branch = `git default-branch`.chomp

# ブランチが存在するか確認し、なければデフォルトブランチから作成
branch_exists = system("git show-ref --verify --quiet refs/heads/#{branch}")
unless branch_exists
  puts "#{branch} ブランチが存在しません。新規作成します。"
  puts "#{default_branch} から #{branch} を作成します。"
  system("git branch #{branch} #{default_branch}")
  puts
end

# worktree名を作成（スラッシュをハイフンに変換）
dir = branch.gsub('/', '-')
worktree_path = "#{parent_dir}/.worktree/#{dir}"

# worktreeを作成
puts "=== Worktreeを作成 ==="
result = system("git worktree add #{worktree_path} #{branch}")
unless result
  puts "Worktreeの作成に失敗しました"
  exit 1
end
puts

# gitignoreされているパスを取得（最小化済み）
puts "=== Gitignoreされているパスを取得 ==="
ignored_paths = `git-ignored-paths`.lines.map(&:chomp)

# 除外パターンに該当するものをフィルタリング
filtered_paths = ignored_paths.reject do |path|
  excludes.any? do |pattern|
    if pattern.include?('*')
      # ワイルドカードパターンの場合
      File.fnmatch(pattern, path) || File.fnmatch(pattern, File.basename(path))
    else
      # 通常のパターンの場合
      path == pattern || path.start_with?("#{pattern}/") || File.basename(path) == pattern
    end
  end
end

# ディレクトリとファイルを分類
dirs = []
files = []

filtered_paths.each do |path|
  full_path = "#{parent_dir}/#{path}"
  if File.directory?(full_path)
    dirs << path
  elsif File.exist?(full_path)
    files << path
  else
    puts "警告: #{path} が存在しません"
  end
end

puts "対象 - ディレクトリ: #{dirs.size}個、ファイル: #{files.size}個"
puts

# ネストしたディレクトリの重複を除去
dirs = dirs.sort.reject do |dir|
  dirs.any? { |other| other != dir && dir.start_with?("#{other}/") }
end

# dirsに含まれるファイルをfilesから除外
files = files.reject do |file|
  dirs.any? { |dir| file.start_with?("#{dir}/") }
end

puts "=== シンボリックリンクを作成 ==="
puts "ディレクトリ: #{dirs.size}個"
puts "ファイル: #{files.size}個"
puts

# ディレクトリのシンボリックリンクを作成
dirs.each do |dir|
  source = "#{parent_dir}/#{dir}"
  target = "#{worktree_path}/#{dir}"

  if File.exist?(target)
    puts "スキップ: #{dir} (既に存在)"
    next
  end

  # 親ディレクトリを作成
  target_parent = File.dirname(target)
  system("mkdir -p #{target_parent}") unless File.exist?(target_parent)

  # シンボリックリンクを作成
  system("ln -s #{source} #{target}")
  puts "リンク作成: #{dir}"
end

# ファイルのシンボリックリンクを作成
files.each do |file|
  source = "#{parent_dir}/#{file}"
  target = "#{worktree_path}/#{file}"

  if File.exist?(target)
    puts "スキップ: #{file} (既に存在)"
    next
  end

  # 親ディレクトリを作成
  target_parent = File.dirname(target)
  system("mkdir -p #{target_parent}") unless File.exist?(target_parent)

  # シンボリックリンクを作成
  system("ln -s #{source} #{target}")
  puts "リンク作成: #{file}"
end

puts
puts "完了: #{worktree_path} に移動してください"
puts "cd #{worktree_path}"
