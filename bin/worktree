#!/usr/bin/env ruby

# 使い方
# worktree <branch名>
#
# 環境変数
# WT_EXCLUDE: カンマ区切りで除外するパターンを追加指定

branch = ARGV[0]

if branch.nil? || branch.empty?
  puts "Usage: worktree <branch名>"
  exit 1
end

# 現在のディレクトリを保存
parent_dir = `pwd`.chomp

# デフォルトの除外パターン
default_excludes = ['.DS_Store', 'tags', '*.log', '.ruby-lsp']
user_excludes = ENV['WT_EXCLUDE']&.split(',')&.map(&:strip) || []
excludes = default_excludes + user_excludes

# デフォルトブランチを取得
default_branch = `git default-branch`.chomp

# ブランチが存在するか確認し、なければデフォルトブランチから作成
branch_exists = system("git show-ref --verify --quiet refs/heads/#{branch}")
unless branch_exists
  puts "#{branch} ブランチが存在しません。新規作成します。"
  puts "#{default_branch} から #{branch} を作成します。"
  system("git branch #{branch} #{default_branch}")
  puts
end

# worktree名を作成（スラッシュをハイフンに変換）
dir = branch.gsub('/', '-')
worktree_path = "#{parent_dir}/.worktree/#{dir}"

# worktreeを作成
puts "=== Worktreeを作成 ==="
result = system("git worktree add #{worktree_path} #{branch}")
unless result
  puts "Worktreeの作成に失敗しました"
  exit 1
end
puts

# gitignoreされているファイル・ディレクトリを取得
puts "=== Gitignoreされているファイル・ディレクトリを取得 ==="
ignored_items = `git ls-files --others --ignored --exclude-standard`.lines.map(&:chomp)

# 除外パターンに該当するものをフィルタリング
filtered_items = ignored_items.reject do |item|
  excludes.any? do |pattern|
    if pattern.include?('*')
      # ワイルドカードパターンの場合
      File.fnmatch(pattern, item) || File.fnmatch(pattern, File.basename(item))
    else
      # 通常のパターンの場合
      item == pattern || item.start_with?(pattern) || File.basename(item) == pattern
    end
  end
end

puts "対象: #{filtered_items.size}個"
puts

# ディレクトリとファイルを分類
# 同じディレクトリ配下に複数ファイルがある場合、ディレクトリ全体にシンボリックリンクを張る
dirs = []
files = []

# 親ディレクトリごとにファイルをグループ化
dir_groups = filtered_items.group_by do |item|
  item.include?('/') ? item.split('/')[0..-2].join('/') : nil
end

# 親ディレクトリに複数ファイルがある場合、ディレクトリにシンボリックリンクを張る
dir_groups.each do |parent, items|
  if parent.nil?
    # ルートレベルのファイル
    files.concat(items)
  elsif items.size > 1 && File.directory?("#{parent_dir}/#{parent}")
    # 同じディレクトリに複数ファイル → ディレクトリ全体にリンク
    dirs << parent unless dirs.include?(parent)
  else
    # 単独ファイル
    items.each do |item|
      if File.directory?("#{parent_dir}/#{item}")
        dirs << item unless dirs.include?(item)
      else
        files << item
      end
    end
  end
end

# ネストしたディレクトリの重複を除去
dirs = dirs.sort.reject do |dir|
  dirs.any? { |other| other != dir && dir.start_with?("#{other}/") }
end

# dirsに含まれるファイルをfilesから除外
files = files.reject do |file|
  dirs.any? { |dir| file.start_with?("#{dir}/") }
end

puts "=== シンボリックリンクを作成 ==="
puts "ディレクトリ: #{dirs.size}個"
puts "ファイル: #{files.size}個"
puts

# ディレクトリのシンボリックリンクを作成
dirs.each do |dir|
  source = "#{parent_dir}/#{dir}"
  target = "#{worktree_path}/#{dir}"

  if File.exist?(target)
    puts "スキップ: #{dir} (既に存在)"
    next
  end

  # 親ディレクトリを作成
  target_parent = File.dirname(target)
  system("mkdir -p #{target_parent}") unless File.exist?(target_parent)

  # シンボリックリンクを作成
  system("ln -s #{source} #{target}")
  puts "リンク作成: #{dir}"
end

# ファイルのシンボリックリンクを作成
files.each do |file|
  source = "#{parent_dir}/#{file}"
  target = "#{worktree_path}/#{file}"

  if File.exist?(target)
    puts "スキップ: #{file} (既に存在)"
    next
  end

  # 親ディレクトリを作成
  target_parent = File.dirname(target)
  system("mkdir -p #{target_parent}") unless File.exist?(target_parent)

  # シンボリックリンクを作成
  system("ln -s #{source} #{target}")
  puts "リンク作成: #{file}"
end

# シンボリックリンクしたディレクトリをworktreeの.git/info/excludeに追加
unless dirs.empty?
  # worktreeの実際のgitディレクトリを取得
  git_dir = `cd #{worktree_path} && git rev-parse --git-dir`.chomp
  exclude_file = "#{git_dir}/info/exclude"

  # info ディレクトリが存在しない場合は作成
  info_dir = File.dirname(exclude_file)
  system("mkdir -p #{info_dir}") unless File.exist?(info_dir)

  File.open(exclude_file, 'a') do |f|
    f.puts "\n# worktreeスクリプトで追加されたシンボリックリンクディレクトリ"
    dirs.each do |dir|
      f.puts "#{dir}/"
    end
  end
  puts "\n.git/info/excludeに#{dirs.size}個のディレクトリを追加しました"
end

puts
puts "完了: #{worktree_path} に移動してください"
puts "cd #{worktree_path}"
