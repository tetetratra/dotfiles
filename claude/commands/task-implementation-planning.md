$1

タスクの内容や設計書（ある場合）を読み込み、実装可能な作業単位に分解して実装計画を立てます。

注意：このコマンドは実装そのものを行わず、「どの順番で何を作るか」を計画するものです。
実際のコード作成は次のステップで行います。
また、この計画はあくまで実装（コードとテストの作成）に関するものであり、動作確認（検証計画・検証実行）は含めません。
動作確認は実装完了後の別ステップで行います。

## 目的

- タスクの内容を実装可能な作業単位（ステップ）に分解する
- 実装の順序と粒度を明確にし、手戻りを最小化する
- 各ステップのテストとコミットのタイミングを計画する

## 入力で確認すること

- 対象タスクのリンクと概要
- 設計書（ある場合）
- 既存コードベースの構造（関連ファイルの配置）
- ブランチ運用ルール（作業ブランチ名のルール等）
- テスト要件
- 情報が不足している場合は、着手前に質問を箇条書きする

## 出力の要件

- `## 実装計画` セクションにそのまま貼れる本文のみを出力
- 構成: (あれば)依存関係の整理 → 実装ステップ → マイルストーン の順
- ですます調で記載し、箇条書き末尾に句点を付けない
- 各ステップは1コミット程度の粒度で分割する
- 実装の順序には明確な理由を付ける
- 実装ステップは箇条書きで記載し、Step Nなどの連番や####見出しは使用しない

## 手順

### 1. タスク内容と設計書の確認

- 設計書がある場合は確認し、実装対象のファイル・クラス・メソッドをリストアップ
- 設計書がない場合は、タスクの内容から実装対象を洗い出す
- データベース変更の有無を確認
- 既存コードとの関係性を把握

### 2. 依存関係の整理

- どのコンポーネントが他のコンポーネントに依存しているか
- 独立して実装・テストできる部分はどこか
- 先に実装すべき基盤部分はどこか
- 並行して実装できる部分はあるか

### 3. 実装順序の決定

基本方針：
- 依存される側から依存する側へ（下位層→上位層）
- データベース変更は優先的に
- 基本的には モデル→コントローラー→ビュー の順
- コア機能→付加機能 の順

ステップの粒度（1ステップ = 1コミット）：
- 1ステップ = 1つの機能または1つのメソッドの実装
- 各ステップは独立してテスト可能な最小単位
- 各ステップ完了時に意味のあるコミットができる状態
- 目安: 30分〜1時間程度で完了できる作業量
- 例:
  - ○ 良い粒度: 「UserAuthentication#authenticate メソッドの実装」
  - × 粗すぎる: 「UserAuthentication モデル全体の実装」
  - × 細かすぎる: 「UserAuthentication#authenticate メソッドの引数チェック部分のみ」

### 4. 実装ステップの作成

各ステップに以下を含める:
- ステップ名（簡潔でわかりやすい名前）
- 実装する内容（ファイル・クラス・メソッド）
- テスト内容
- コミットメッセージの例
- 所要時間の見積もり（任意）

各ステップは箇条書きで記載し、####見出しは使用しない

### 5. マイルストーンの設定

マイルストーンの粒度（1マイルストーン = 1PR）：
- マイルストーンは、それ単体で意味が完結している機能単位
- 各マイルストーン完了時にPRを作成できる状態
- ユーザーや他の開発者が価値を理解できる単位
- 目安: 複数のステップ（コミット）をまとめた、独立して動作確認できる機能

マイルストーンの条件：
- その機能単体で動作確認が可能
- リリースしなくても、動作させて価値を確認できる
- レビュワーが機能の意図と効果を理解できる
- 他の機能に依存せず、独立してテスト可能

例：
- ○ 良いマイルストーン: 「ユーザー認証API全体が動作」「管理画面でデータ閲覧が可能」
- × 悪いマイルストーン: 「モデルのメソッド5個を実装」「コントローラーのコードを書いた」

設定すべき内容：
- マイルストーン到達時点で何ができるようになるか
- どのような方法で動作確認が可能な状態か（rails console、curl、ブラウザ等）
- そのマイルストーンのビジネス的な意味

注：マイルストーンでは「動作確認が可能な状態」を示すが、実際の動作確認は実装完了後の別ステップで行う

## 出力例

```
## 実装計画

### 依存関係の整理

優先順位：
1. マイグレーション（すべての実装の前提）
2. UserAuthentication モデル（コントローラーが依存）
3. SessionsController（モデルに依存）

独立実装可能：
- UserAuthentication モデルの各メソッドは独立して実装可能
- テストファイルは対応する実装と同時に作成

### 実装ステップ

- ブランチ作成
  - develop から feature/oauth-authentication ブランチを作成
  - コミットなし

- マイグレーション作成・実行
  - db/migrate/20250101_add_oauth_tokens_to_users.rb を作成
    - oauth_provider, oauth_uid, oauth_token カラムを追加
    - インデックス: oauth_provider + oauth_uid のユニーク制約
  - マイグレーション実行とロールバックの動作確認
  - テスト: マイグレーションのロールバック確認

- UserAuthentication モデルの骨組み
  - app/models/user_authentication.rb を作成
  - クラス定義と空のpublicメソッドを定義
    - .authenticate_with_oauth(provider, uid, token)
    - .find_or_create_from_oauth(provider, uid, user_attributes)
  - spec/models/user_authentication_spec.rb を作成（テストケース定義のみ）
  - テスト: 実行はせず、rspecが認識することのみ確認

- UserAuthentication#authenticate_with_oauth 実装
  - .authenticate_with_oauth メソッドの実装
    - OAuth認証の検証ロジック
    - トークンの有効性確認
  - spec/models/user_authentication_spec.rb に対応するテストを追加
  - テスト: rspec spec/models/user_authentication_spec.rb（該当メソッドのみ）

- UserAuthentication#find_or_create_from_oauth 実装
  - .find_or_create_from_oauth メソッドの実装
    - 既存ユーザーの検索
    - 新規ユーザーの作成
  - spec/models/user_authentication_spec.rb に対応するテストを追加
  - テスト: rspec spec/models/user_authentication_spec.rb

- SessionsController の OAuth対応
  - app/controllers/api/sessions_controller.rb に #oauth_create アクションを追加
    - UserAuthentication を使用した認証処理
    - セッション生成
  - spec/controllers/api/sessions_controller_spec.rb に対応するテストを追加
  - テスト: rspec spec/controllers/api/sessions_controller_spec.rb

- 統合テスト
  - spec/requests/oauth_authentication_spec.rb を作成
  - OAuth認証の全体フローをテスト
    - 新規ユーザーの認証
    - 既存ユーザーの認証
    - エラーケース
  - テスト: rspec spec/requests/oauth_authentication_spec.rb

- 最終確認
  - すべてのテストが通過することを確認
  - lintチェック実行
  - 設計書がある場合は整合性確認
  - コミットなし（必要に応じて修正）

### マイルストーン

M1: UserAuthentication#find_or_create_from_oauth 実装完了時点
- UserAuthentication モデル単体が動作確認可能
- rails console で動作確認ができる状態

M2: SessionsController の OAuth対応完了時点
- API経由でOAuth認証が可能
- curlやPostmanで動作確認ができる状態

M3: 最終確認完了時点
- すべての実装とテストが完了
- レビュー依頼が可能な状態

### 備考

- 各ステップ完了時にコミットを行う
- 問題が見つかった場合は該当ステップに戻って修正
```

## チェックポイント

全体：
- [ ] 設計書がある場合、その内容がすべて実装ステップに含まれているか
- [ ] 依存関係が考慮された順序になっているか
- [ ] 独立実装可能な部分が明示されているか
- [ ] ですます調で、箇条書き末尾に句点がないか
- [ ] `## 実装計画` としてそのまま貼れる体裁か

ステップの粒度（1ステップ = 1コミット）：
- [ ] 各ステップが30分〜1時間程度で完了できる粒度か
- [ ] 各ステップが独立してテスト可能か
- [ ] 各ステップでコミットメッセージが明確か
- [ ] ステップが細かすぎたり粗すぎたりしないか

マイルストーンの粒度（1マイルストーン = 1PR）：
- [ ] 各マイルストーンがそれ単体で意味が完結しているか
- [ ] マイルストーン完了時点で動作確認が可能か
- [ ] レビュワーが価値を理解できる粒度か
- [ ] PRとして切り出せる単位になっているか
