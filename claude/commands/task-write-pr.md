$1

PRの背景・目的、変更内容、動作確認のセクションを体系的に作成し、PRを作成・更新します。

## 使用例

```
/write-pr https://github.com/org/repo/pull/XXXXX のPRに対してお願いします
```

## 出力物

このコマンドでは、以下の3つのカテゴリで出力を行います：

- **返答**: 作業完了の報告や調査結果の要約など、フロー型の出力（会話として返す）
- **成果物**: ドキュメントや整理結果など、ストック型の出力（後から参照できる形で返す）
  - 成果物の保存先について指示がある場合は、指定された箇所に書き込む
  - 指示がない場合は、通常のレスポンスとして返答の後に続けて出力する
- **作業**: システムへの変更や実行など、副作用を伴う作業

本コマンドの出力：

**返答**: PR作成・更新の完了を報告する

**成果物**: PR説明文（背景・目的、変更内容、動作確認）

**作業**: PR作成（未作成の場合）、PR説明文の更新

## 手順

前段までに各項目を整理済みの場合は、それを参考にすること。

1. **技術的な直接目的の把握**
   - PRの変更内容から、技術的に何を実現しようとしているかを整理する
   - 「このPRは何をするものか？」を明確にする

2. **根本目的の探索**
   - 「なぜその技術的変更が必要なのか？」を深掘りする
   - 単なる機能追加や修正ではなく、ビジネス上や運用上の課題を探る

3. **背景情報の収集**
   - PRのコメントにNotionリンクがあるかを確認し、あれば必ず参照する
   - PRに紐づくNotionチケット、GitHub Issue、コメントを確認
   - 過去の障害レポートや関連する議論を調査
   - 必要に応じて関連するチケットも確認する

4. **目的の連鎖整理**
   以下の3層で目的を段階的に整理し、それぞれを文章として明確に表現する：
   ```
   根本目的: ビジネス上の課題解決や障害防止など（なぜこの取り組みが必要か）
   ↓
   中間目的: 技術的な仕組みの改善や導入（どのような手段で解決するか）
   ↓
   直接的作業: 今回のPRで実際に行う変更内容（具体的に何をするか）
   ```

5. **背景・目的セクション作成**
   - 内容
       - 時系列で背景を説明（いつ何が起きたか）
       - 原因と根本原因を明確に分ける
       - なぜ今回の対応が必要かの論理的つながりを示す
       - 現状の問題と今回の解決アプローチを説明
       - 「◯◯な必要があり、本PRで対応しました」のように、PRの目的を明確に述べる
   - 記法
       - 基本的に見出しや太字は避け、文章で書く（バッククォートによる囲みは使用可）
       - ですます調で、全体として3〜7文程度のまとまりで記述する
       - 文ごとに改行を入れ、段落の区切りには空行を入れる
       - チケットやPR、出来事に対する言及はリンクとして記載する

例：
```
(チケットへのリンク) で実装したXX表示機能では、開始日時と終了日時をstring型として扱っていました。
しかし、日時データをstring型で扱うと、管理画面での入力時に誤った形式で入力されるリスクがあり、また型安全性の観点からも改善の余地がありました。

本PRでこの改善に対応しました。
date型をサポートすることで、管理画面でdatetime-localフィールドを使った直感的な日時入力が可能になり、型レベルでの安全性も向上します。

また、内部実装についても、文字列ベースから型付き値ベースへのリファクタリングを行い、バリデーションを型チェックに統一することで、より堅牢な実装としました。
```

6. **変更内容セクション作成**
   - PRの技術的変更内容のうち、主要なポイントを整理して記述
     - 逆に、細かすぎる変更点は省略する
   - 特定の手順に則って変更を加えた場合は、その手順に関する説明も記載する
       - たとえば、変更にあたって実行したコマンド(rakeタスクなど)があれば記載する

良い例：
```
## 変更内容
- date型のサポートを追加
- 管理画面UIの改善
  - 細かな変更なので、実際の変更はコードを参照してください
- ...
```

悪い例：
```
## 変更内容
### 1. date型のサポート追加
- schemaに`date`型を追加
- `str_to_value`/`value_to_str`でdate型の変換処理を実装
  - 文字列からTimeオブジェクトへの変換
  - TimeオブジェクトからISO8601形式文字列への変換
- date型のバリデーション追加（Time/ActiveSupport::TimeWithZoneの型チェック）
- ...

### 2. 管理画面UIの改善
- 表示を日本語化（文字列、真偽値、整数、日付）し、英語名も併記
- ...
### 3. ...
```

7. **動作確認セクション作成**
   - 前段までに動作確認方法を検討済みの場合：
     - チェックボックス形式で確認項目を `## 動作確認` セクションに記載する
     - その確認も実施済みの場合は、チェックを埋める（`- [x]`）
       - スクショ等を撮っている場合、そのスクショも記載してください
       - スクショを記載する際、スクショの表示サイズは500px幅程度に抑え、多い場合はsummaryタグで折りたたむなど工夫してください
     - 未実施の場合は、チェックを空にする（`- [ ]`）
       - この作業において未実施の動作確認を実施する必要はありません
   - 動作確認方法を未検討の場合：
     - `## 動作確認` セクションに「未検討」と記載する

例：
```
## 動作確認

開発環境で以下を確認します

- [x] 管理画面での日時の入力が正しく動作することを確認
- [x] 入力した日時がxxの画面に正しく反映されることを確認

QA環境で以下を確認します

- [ ] 管理画面での日時の入力が正しく動作することを確認
- [ ] 入力した日時がxxの画面に正しく反映されることを確認
```

8. **PR作成または概要欄への反映**
   - まず `gh pr view` でPRの状態を確認する
   - PR未作成の場合：
     - `gh pr create --draft` で必ずdraftとして作成する
     - レビュワーは追加しない
     - デフォルトのPRテンプレートを使用する
     - テンプレート内の `## 背景・目的`、`## 変更内容`、`## 動作確認` セクションのみ書き込む
     - 他のセクション（チェックリストなど）には一切手を加えない
   - PR作成済みの場合：
     - `gh pr edit` コマンドを使用してPRの概要欄を更新する
     - `## 背景・目的` セクションを追加または更新
     - `## 変更内容` セクションを追加または更新
     - `## 動作確認` セクションを追加または更新
     - 既存のテンプレート構造を維持しながら該当セクションのみ更新

9. **チェックポイントの確認**

## 実行例

```bash
# 1. PRの技術的内容確認
gh pr view {PR番号}

# 2. 関連チケット確認
gh pr view {PR番号} --comments
# Notionチケットのリンクを見つけて内容確認

# 3. 目的連鎖の整理
# 根本目的 → 中間目的 → 直接的作業の流れを文章化

# 4. 背景・目的セクション作成
# - 障害・課題の発生
# - 原因分析
# - 解決の必要性
# - 現状の問題
# - 今回のアプローチ

# 5. 変更内容セクション作成
# - 技術的変更内容の整理
# - ファイル・機能の変更概要
# - 主要な変更ポイント

# 6. 動作確認セクション作成
# - 前段までに動作確認方法を検討済みの場合はチェックボックス形式で記載
# - 確認も実施済みの場合はチェックを埋める
# - 未検討の場合は「未検討」と記載

# 7. PR作成または概要欄への反映
# PR状態を確認
gh pr view

# PR未作成の場合
gh pr create --draft --body "PRテンプレートに基づいた本文"
# - draftとして作成
# - レビュワーは追加しない
# - デフォルトテンプレートの ## 背景・目的、## 変更内容、## 動作確認 のみ記入
# - 他のセクションには手を加えない

# PR作成済みの場合
gh pr edit {PR番号} --body "更新されたPR本文"
# - ## 背景・目的セクションを追加または更新
# - ## 変更内容セクションを追加または更新
# - ## 動作確認セクションを追加または更新
```

## チェックポイント

- [ ] 根本的な「なぜ」が明確になっているか
- [ ] 技術的変更とビジネス価値のつながりが説明されているか
- [ ] 時系列が整理されているか
- [ ] 読み手が背景を理解できる情報が含まれているか
- [ ] 今回の対応の妥当性が伝わるか
- [ ] ですます調の文章構成になっているか
- [ ] 文章が3〜7文程度のまとまりで記述されているか
- [ ] 文ごとに改行され、段落の区切りには空行が入っているか
- [ ] チケットやPRの言及がリンクとして記載されているか
- [ ] `## 背景・目的` セクションがPR概要欄に追加されているか
- [ ] `## 変更内容` セクションがPR概要欄に追加されているか
- [ ] 主要な技術的変更が変更内容セクションに記載されているか
- [ ] `## 動作確認` セクションがPR概要欄に追加されているか
- [ ] 動作確認方法を検討済みの場合、チェックボックス形式で確認項目が記載されているか
- [ ] 確認も実施済みの場合、該当するチェックが埋められているか
- [ ] 動作確認方法を未検討の場合、「未検討」と記載されているか
- [ ] PR未作成の場合、`gh pr create --draft` で作成されているか
- [ ] PR未作成の場合、レビュワーが追加されていないか
- [ ] PR未作成の場合、デフォルトテンプレートが使用され、指定セクション以外に手を加えていないか
- [ ] PR作成済みの場合、`gh pr edit` コマンドで更新されているか
