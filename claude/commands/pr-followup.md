$1

PR作成後に発生する問題（CI失敗、レビュー指摘、コンフリクト）を確認し、優先順位をつけて対応します。

## 目的

- PR作成後のCI失敗、レビュー指摘、コンフリクトなどの問題を把握する
- 優先順位をつけて対応する
- 修正後に適切に確認・コミット・プッシュする
- 必要に応じてPR説明を更新する

## 入力で確認すること

- 対象PRのURLまたは番号
- CI状態
- レビューコメント
- コンフリクトの有無
- プロジェクトのブランチ運用ルール（rebase/merge）
- 情報が不足している場合は、着手前に質問を箇条書きする

## 出力の要件

- レスポンスとして直接返す（ドキュメントファイルは作成しない）
- 対応が必要な問題を優先順位順に整理する
- 各問題に対する対応方針と実施内容を記載する
- 修正完了後、何を確認したかを記録する

## 手順

### 1. PR状態の確認

以下を確認して、どのような問題があるかを把握する：

- CI状態の確認（`gh pr checks`）
  - 失敗しているジョブの特定
  - circleci-mcp-server のツールでログを取得（可能な場合）
- レビューコメントの確認（`gh pr view --comments`）
  - 未解決のコメントを抽出
  - 対応が必要な指摘を整理
- コンフリクトの有無（`gh pr view` の Mergeable 状態）
  - コンフリクトが発生しているか確認

### 2. 対応優先度の決定

以下の優先順位で対応する：

1. **コンフリクトの解決**（最優先）
   - コンフリクトがあると他の作業が無駄になる可能性があるため
   - ベースブランチの最新を取得
   - プロジェクトのルールに従って rebase または merge を実行
   - コンフリクト箇所を手動で解決
   - テスト実行で問題ないか確認
   - force push（rebaseの場合）または通常push

2. **CI失敗の修正**
   - 失敗したジョブのログを分析
   - 失敗原因の特定（テスト失敗、Lint、型エラー、ビルドエラーなど）
   - 修正方針の決定
   - 修正実装
   - ローカルで該当テスト/チェックを実行して確認
   - コミット・プッシュ

3. **レビュー指摘への対応**
   - 未解決のコメントを1つずつ確認
   - 各指摘に対する対応方針を決定：
     - 修正が必要 → 実装して対応
     - 説明が必要 → コメントで返信
     - 議論が必要 → 質問や提案をコメント
   - 修正が必要なものを実装
   - テスト実行
   - コミット・プッシュ
   - レビューコメントに返信（何をどう対応したか）

### 3. 追加の動作確認（必要な場合）

- レビュアーから指摘された追加確認項目の実施
- 修正による影響範囲の確認
- 追加実装に対する動作確認

### 4. PR説明の更新（必要な場合）

- 追加変更に伴う背景・目的の補足
- 追加変更に伴う変更内容の更新
- 追加の動作確認結果の追記
- レビュアーからの質問への回答をPR説明に反映

### 5. 対応完了の確認

- すべての問題が解決されたか確認
- CI が通過しているか確認
- レビューコメントに返信できているか確認
- コンフリクトが解消されているか確認

## 出力例

```
## PR状態確認

**CI状態**:
- ❌ Lint: Rubocop エラー 3件
- ❌ Test: RSpec 2件失敗
- ✅ Build: 成功

**レビューコメント**:
- @reviewer1: メソッド名を具体的にしてほしい（未解決）
- @reviewer2: テストケースを追加してほしい（未解決）

**コンフリクト**: なし

## 対応方針

優先順位に従って以下を実施：

1. CI失敗の修正
   - Rubocop エラー 3件を修正
   - RSpec 2件の失敗を修正
2. レビュー指摘への対応
   - メソッド名の変更
   - テストケースの追加

## 実施内容

### 1. Rubocop エラーの修正

- `app/models/user.rb:45`: 行が長すぎる → メソッド抽出で対応
- `app/controllers/users_controller.rb:23`: 未使用変数 → 削除
- `spec/models/user_spec.rb:67`: インデント不正 → 修正

ローカルで確認：
```bash
bundle exec rubocop app/models/user.rb app/controllers/users_controller.rb spec/models/user_spec.rb
```

結果: すべて通過

### 2. RSpec 失敗の修正

- `spec/models/user_spec.rb:123`: 日付の比較で失敗 → タイムゾーン考慮を追加
- `spec/requests/users_spec.rb:45`: 期待値のミス → 修正

ローカルで確認：
```bash
bundle exec rspec spec/models/user_spec.rb:123 spec/requests/users_spec.rb:45
```

結果: すべて通過

コミット・プッシュ完了。CI再実行を確認中。

### 3. レビュー指摘への対応

**@reviewer1: メソッド名を具体的に**
- `process_data` → `convert_csv_to_user_attributes` に変更
- テストも更新

**@reviewer2: テストケースを追加**
- エッジケース（空文字、nil）のテストを追加
- `spec/models/user_spec.rb` に3ケース追加

ローカルで確認：
```bash
bundle exec rspec spec/models/user_spec.rb
```

結果: すべて通過

コミット・プッシュ完了。レビューコメントに返信済み。

## 対応完了確認

- ✅ CI: すべてのジョブが通過
- ✅ レビューコメント: すべて返信・対応済み
- ✅ コンフリクト: なし

次のステップ: レビュアーの再確認を待つ
```

## チェックポイント

- [ ] PR状態（CI、レビュー、コンフリクト）を正しく確認できているか
- [ ] 対応優先度が適切か（コンフリクト > CI > レビュー）
- [ ] 各問題に対する対応方針が明確か
- [ ] 修正後にローカルで確認を実施しているか
- [ ] コミット・プッシュが適切に行われているか
- [ ] レビューコメントに返信しているか
- [ ] 必要に応じてPR説明を更新しているか
- [ ] 対応完了後、すべての問題が解決されているか確認しているか
