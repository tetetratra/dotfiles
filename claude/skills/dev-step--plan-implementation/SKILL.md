---
description: タスクの実装を作業ステップに分解し、順序と粒度を計画する。
---

## 目的

- タスクの内容を実装可能な作業単位（ステップ）に分解する
- 実装の順序と粒度を明確にし、手戻りを最小化する
- 各ステップのテストとコミットのタイミングを計画する

注意：このコマンドは実装そのものを行わず、「どの順番で何を作るか」を計画するものです。
実際のコード作成は次のステップで行います。
また、この計画はあくまで実装（コードとテストの作成）に関するものであり、動作確認（検証計画・検証実行）は含めません。
動作確認は実装完了後の別ステップで行います。

## 指針

以下の指針に従って計画を作成してください。

### 実装順序（TDD的アプローチ）

各機能の実装は、以下の順序をデフォルトとする:

1. **骨組みの作成**: クラス定義とpublicメソッドのシグネチャのみを実装する（中身は空やNotImplementedError等）
2. **テストの作成**: 骨組みに対する単体テストを作成する（失敗することを確認）
3. **中身の実装**: テストが通るように各メソッドの中身を実装する（テストを通す）
4. **リファクタリング**: 必要に応じてコードの整理・改善を行う（テストが通ることを確認）

- 統合テストは上記の後、別途最後のステップで書く

### ステップの粒度

- ブランチが切られていない場合、最初にブランチを切るステップを追加する
  - ブランチ名は、READMEや他のスキル等に命名ルールがあればそれに従う。無い場合、`{prefix}/{チケット番号}-{短い説明}`とする
    - prefix には「feature」「bugfix」「hotfix」など適切なものを入れる
    - 例: `feature/123-add-user-authentication`
- 1ステップ = 1つの(コードベース上の)機能の実装・修正になるような粒度に分解する
- 各ステップは独立してテスト可能な最小単位にする
- 各ステップ完了時に意味のあるコミットができる状態にする

### コミットの粒度

- **骨組みの作成**: 全ファイルまとめて1コミット
- **テストの作成**: ファイルごとに1コミット（1ステップ）
- **中身の実装**: ファイルごとに1コミット（1ステップ）
- **リファクタリング**: 必要に応じて適切な粒度で1コミット（1ステップ）

## 出力フォーマット

以下のフォーマットで出力してください。

- ファイルパスには `追加:` （新規ファイル）または `修正:` （既存ファイル）等のプレフィックスを付ける
- テストのステップでは、テストの階層構造を示す
- 実装のステップでは、メソッド名（publicメソッドのみ）とその処理内容を木構造風に示す
- 各ステップにコミットメッセージ案を含める

```
## 実装計画

- {ステップ名}
  - 追加/修正: `{ファイルパス}`
    - {そのファイルに対して行うことを書く}
  - コミット: `{コミットメッセージ案}`

- ...
```

## 出力例

管理画面からユーザーへの一括通知機能を追加する場合の例:

```
## 実装計画

- ブランチ作成
  - `feature/456-bulk-user-notification` を develop から作成
  - コミットなし

- コードの骨組み作成
  - 追加: `app/services/bulk_user_notifier.rb`
    - クラス定義と `#call` メソッドのシグネチャのみ
  - 修正: `app/controllers/admin/users_controller.rb`
    - `#notify_all` アクションのシグネチャのみ追加
  - コミット: `一括ユーザー通知の骨組みを作成`

- BulkUserNotifierのテスト作成
  - 追加: `spec/services/bulk_user_notifier_spec.rb`
  - テスト構造:
    - describe "#call"
      - context "対象ユーザーが複数件の場合"
        - it "全員に通知が送信されること"
      - context "対象ユーザーが0件の場合"
        - it "エラーなく正常完了すること"
  - コミット: `BulkUserNotifierのテストを実装`

- notify_allアクションのテスト作成
  - 修正: `spec/controllers/admin/users_controller_spec.rb`
  - 追加するテスト構造:
    - describe "POST #notify_all"
      - context "正常系"
        - it "BulkUserNotifierを呼び出しリダイレクトすること"
      - context "権限がない場合"
        - it "403を返すこと"
  - コミット: `notify_allアクションのテストを実装`

- BulkUserNotifierの実装
  - 修正: `app/services/bulk_user_notifier.rb`
  - メソッド構成:
    - `#call`
      - 対象ユーザーの取得 → フラグ更新 → 通知送信
    - `#find_target_users`
      - 条件に合致するユーザーをRelationで返す
    - `#send_notifications(target_user_ids)`
      - 1件ずつ通知送信、1000件ごとに進捗ログ出力
  - コミット: `BulkUserNotifierの処理を実装`

- notify_allアクションの実装
  - 修正: `app/controllers/admin/users_controller.rb`
    - `#notify_all` の中身を実装
  - 修正: `config/routes.rb`
    - admin/users に `post :notify_all` を追加
  - コミット: `notify_allアクションの処理を実装`

- リファクタリング
  - （実装を振り返り、必要に応じてコードを整理・改善する）
```
